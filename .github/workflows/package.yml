name: Package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup .NET 10.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Extract version from tag
        id: get_version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/v(.+)') {
            $tagVersion = $matches[1]
            
            # サフィックスを分離 (例: 1000-test → 数字部分: 1000, サフィックス: -test)
            if ($tagVersion -match '^(\d+)(.*)$') {
              $numberPart = $matches[1]
              $suffix = $matches[2]
              
              # 数字部分を4桁のバージョンに変換
              $major = $numberPart.Substring(0, 1)
              $minor = if ($numberPart.Length -gt 1) { $numberPart.Substring(1, 1) } else { "0" }
              $patch = if ($numberPart.Length -gt 2) { $numberPart.Substring(2, 1) } else { "0" }
              $build = if ($numberPart.Length -gt 3) { $numberPart.Substring(3, 1) } else { "0" }
              $version = "$major.$minor.$patch.$build$suffix"
            } else {
              # v1.0.0 や v1.0.0-test のような通常形式はそのまま使用
              $version = $tagVersion
            }
          } else {
            $version = "0.0.0.0"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Restore dependencies
        run: dotnet restore RxExtends4WinForms.sln

      - name: Build
        run: dotnet build RxExtends4WinForms.sln --configuration Release --no-restore

      - name: Create NuGet package
        run: dotnet pack src/RxExtends4WinForms.csproj --configuration Release --no-build --output packages /p:PackageVersion=${{ steps.get_version.outputs.VERSION }}

      - name: List created packages
        shell: pwsh
        run: |
          Write-Host "Listing packages directory:"
          if (Test-Path packages) {
            Get-ChildItem packages -Recurse
          } else {
            Write-Host "packages directory does not exist"
          }

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: packages/*.nupkg

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: packages/*.nupkg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to NuGet.org
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $packages = Get-ChildItem -Path packages -Filter *.nupkg
          foreach ($package in $packages) {
            Write-Host "Publishing $($package.FullName)..."
            dotnet nuget push $package.FullName --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          }
